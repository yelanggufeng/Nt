<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <link th:href="@{/css/update.css}" rel="stylesheet"/>
    <th:block th:include="include :: header('新增数字小微园信息')"/>
    <th:block th:include="include :: datetimepicker-css"/>
    <link th:href="@{/ajax/libs/bootstrap-fileinput/fileinput.min.css}" rel="stylesheet"/>
</head>
<body class="">
<div class="main-content ">
    <form class="form-horizontal" id="form-park-add">


        <input id="lon" name="lon" type="hidden">
        <input id="lat" name="lat" type="hidden">
        <input id="fileUuid" name="fileUuid" type="hidden" th:value="${uuid}">

        <div class="Y128_title"><span class="icon"></span><span>基础信息</span></div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">数字小微园名称：</label>
                    <div class="col-sm-8">
                        <input name="parkName" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">数字小微园建设状态：</label>
                    <div class="col-sm-8">
                        <select name="constructionState" class="form-control m-b"
                                th:with="type=${@dict.getType('construction_state')}" required>
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">所属区域：</label>
                    <div class="col-sm-8">
                        <select name="areaId" class="form-control m-b" th:with="type=${@dict.getAreaList()}" required>
                            <option value="">所有</option>
                            <option th:each="dict : ${type}" th:text="${dict.key}" th:value="${dict.value}"></option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">开工时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input name="startTime" class="form-control" type="text">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">数字小微园地址：</label>
                    <div class="col-sm-8">
                        <input name="detailedAddress" class="form-control" type="text">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">竣工时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input name="completionTime" class="form-control" type="text">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">主导产业：</label>
                    <div class="col-sm-8">
                        <select name="leadingIndustryId" class="form-control m-b"
                                th:with="type=${@dict.getType('leading_industry')}">
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}"></option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">投运时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input name="commissioningTime" class="form-control" type="text">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">入驻企业数量：</label>
                    <div class="col-sm-8">
                        <input name="enterpriseQuantity" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">园区等级：</label>
                    <div class="col-sm-8">
                        <select name="parkLevel" class="form-control m-b"
                                th:with="type=${@dict.getType('sys_park_level')}">
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">预计销售收入(万元)：</label>
                    <div class="col-sm-8">
                        <input name="estimatedSalesRevenue"  class="form-control"
                               type="text" number="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">预计形成总利税(万元)：</label>
                    <div class="col-sm-8">
                        <input name="estimatedProfitTax"  class="form-control"
                               type="text" number="true">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">新增方式：</label>
                    <div class="col-sm-8">
                        <select name="newWay" class="form-control m-b"
                                th:with="type=${@dict.getType('sys_new_way')}">
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}" ></option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">开发建设模式：</label>
                    <div class="col-sm-8">
                        <select name="developmentConstructionMode" class="form-control m-b"
                                th:with="type=${@dict.getType('development_mode')}">
                            <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                    th:value="${dict.dictValue}" ></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-1 control-label" style=" padding-top: 65px; width: 12%">园区介绍：</label>
                    <div class="col-sm-9">
                        <textarea name="parkDesc" id="parkDesc" style="height: 150px; width: 100%"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="Y128_title"><span class="icon"></span><span>园区照片</span></div>

            <div class="col-sm-12">
                <input id="fileinput-demo-1" type="file" name="file" multiple>
            </div>

            <div class="col-sm-12 select-table table-striped">
                <table id="bootstrap-table" data-mobile-responsive="true"></table>
            </div>
        </div>



        <div class="form-group">
            <div class="Y128_title"><span class="icon"></span><span>实景图</span></div>

            <div class="col-sm-12">
                <input id="fileinput-demo-2" type="file" name="file2" multiple>
            </div>
        </div>

        <input type="hidden" name="liveView" id="liveView"/>

        <iframe id="mapIframe" class="mapIframe" src="/map" frameborder="0"></iframe>

        <div class="Y128_title"><span class="icon"></span><span>建设规模信息</span></div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">规划建筑面积(万㎡)：</label>
                    <div class="col-sm-8">
                        <input name="planBuildingSpace" class="form-control" type="text" number="true" required>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">占地面积(亩)：</label>
                    <div class="col-sm-8">
                        <input name="landSpace" class="form-control" type="text" number="true" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">已建建筑面积(万㎡)：</label>
                    <div class="col-sm-8">
                        <input name="usedBuildingSpace" id="usedBuildingSpace" class="form-control" type="text"
                               number="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">宿舍面积(万㎡)：</label>
                    <div class="col-sm-8">
                        <input name="dormitorySpace" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">进度情况(%)：</label>
                    <div class="col-sm-8">
                        <input name="progress" id="progress" class="form-control" type="text" number="true" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">建设(改造)模式：</label>
                    <div class="col-sm-8">
                        <input name="buildMode" class="form-control" type="text">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">已出租面积(万㎡)：</label>
                    <div class="col-sm-8">
                        <input name="rentSituation" id="rentSituation" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="Y128_title"><span class="icon"></span><span>建设投资信息</span></div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">计划投资总额(万元)：</label>
                    <div class="col-sm-8">
                        <input name="planInvestmentTotal" class="form-control" type="text">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">国有投资(万元)：</label>
                    <div class="col-sm-8">
                        <input name="stateOwnedInvestment" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">集体投资(万元)：</label>
                    <div class="col-sm-8">
                        <input name="collectiveInvestment" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">民营投资(万元)：</label>
                    <div class="col-sm-8">
                        <input name="privateInvestment" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">其他投资(万元)：</label>
                    <div class="col-sm-8">
                        <input name="otherInvestment" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">实际投资总额(万元)：</label>
                    <div class="col-sm-8">
                        <input name="actualInvestmentTotal" class="form-control" type="text" number="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="Y128_title"><span class="icon"></span><span>建设方信息</span></div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">建设单位名称：</label>
                    <div class="col-sm-8">
                        <input name="buildUnitName" class="form-control" type="text">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系人：</label>
                    <div class="col-sm-8">
                        <input name="buildContactName" class="form-control" type="text" isName="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系方式：</label>
                    <div class="col-sm-8">
                        <input name="buildContactTel" class="form-control" type="text" isPhone="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系邮箱：</label>
                    <div class="col-sm-8">
                        <input name="buildContactMail" class="form-control" type="text" email="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="Y128_title"><span class="icon"></span><span>运营方信息</span></div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">运营单位名称：</label>
                    <div class="col-sm-8">
                        <input name="operationUnitName" class="form-control" type="text">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系人：</label>
                    <div class="col-sm-8">
                        <input name="operationContactName" class="form-control" type="text" isName="true">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系方式：</label>
                    <div class="col-sm-8">
                        <input name="operationContactTel" class="form-control" type="text" isPhone="true">
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-3 control-label">联系邮箱：</label>
                    <div class="col-sm-8">
                        <input name="operationContactMail" class="form-control" type="text" email="true">
                    </div>
                </div>
            </div>
        </div>


    </form>


</div>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: datetimepicker-js"/>
<script th:src="@{/ajax/libs/bootstrap-fileinput/fileinput.min.js}"></script>
<script type="text/javascript">
    var prefix = ctx + "smallpark/park"
    $("#form-park-add").validate({
        focusCleanup: true
    });

    function submitHandler() {
        var lon = $("#mapIframe").contents().find("#lon").val().trim();
        var lat = $("#mapIframe").contents().find("#lat").val().trim();
        var usedBuildingSpace = $("#usedBuildingSpace").val();
        var rentSituation = $("#rentSituation").val();
        $("#lon").val(lon);
        $("#lat").val(lat);
        if (lon.length == 0 || lat.length == 0) {
            $.modal.alertWarning("请填写经纬度");
            return false;
        }

        if ($.validate.form()) {
            if (parseInt(rentSituation) > parseInt(usedBuildingSpace)) {
                $.modal.alertWarning("已出租面积不得大于已建建筑面积！");
                $("rentSituation").focus();
                return false;
            }
            if(parseInt(progress)>100 || parseInt(progress)<0){
                $.modal.alertWarning("进度情况填写错误！");
                $("progress").focus();
                return false;
            }
            $.operate.save(prefix + "/add", $('#form-park-add').serialize());
        }
    }

    $("input[name='startTime']").datetimepicker({
        format: "yyyy-mm-dd",
        minView: "month",
        autoclose: true
    });

    $("input[name='completionTime']").datetimepicker({
        format: "yyyy-mm-dd",
        minView: "month",
        autoclose: true
    });

    $("input[name='commissioningTime']").datetimepicker({
        format: "yyyy-mm-dd",
        minView: "month",
        autoclose: true
    });

    $(document).ready(function () {
        var options = {
            id: "bootstrap-table",
            url: prefix + "/query/file",
            modalName: "附件上传",
            columns: [
                {
                    field: 'id',
                    title: '附件id',
                    visible: false
                },
                {
                    field: 'fileName',
                    title: '文件名称'
                },
                {
                    title: '操作',
                    align: 'center',
                    formatter: function (value, row, index) {
                        var actions = [];
                        actions.push(' <a class="btn btn-danger btn-xs ' + '"  href="javascript:void(0)"  onclick="removefile(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a> ');
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);
        $(".fixed-table-toolbar").hide();


        var control = $('#fileinput-demo-1');
        control.fileinput({
            language: 'zh', //设置语言
            uploadUrl: '/common/upload', //上传的地址
            deleteUrl: prefix + '/removeFile',//删除图片地址
            allowedFileExtensions: ['jpg', 'png', 'gif', 'doc', 'xlsx', 'xls','pdf','docx'],//接收的文件后缀
            showUpload: true, //是否显示上传按钮

            showCaption: true,//是否显示标题
            browseClass: "btn btn-primary", //按钮样式
            // previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
            // preferIconicPreview: true,
            // overwriteInitial: false,//覆盖初始化
            // showRemove: false, //是否显示清除按钮
            // initialPreview: [ "<img src='/img/profile.jpg' class='file-preview-image'>", "<img src='/img/top.png' class='file-preview-image'>"],//编辑时显示
            // initialPreviewConfig: [ { url:prefix + '/removeFile',key: '5'}, { url:prefix + '/removeFile',key: '6' } ]//编辑时显示图片相关属性， key:文件id, url: 删除方法
        });
        //files为fileinput控件ID，
        $('#fileinput-demo-1').on('fileuploaded', function (e, data, previewId, index) {
            //在上传成功事件中将服务器返回的所需数据，添加到该文件对应的div中
            $('#' + previewId).attr('fileid', data.response.data);
            var ids = "";
            $.ajax({
                data: {
                    file_type_id: $("#id").val(),
                    id: data.response.id,
                    policy_type_id: $("#policyTypeId").val(),
                    file_name: data.response.oriname,
                    file_alias: data.response.alias,
                    file_path: data.response.fileName,
                    fileUuid: $("#fileUuid").val(),
                },
                dataType: 'json',
                type: "POST",
                url: prefix + "/uploadfile",
                success: function (data) {
                    ids = data.value;
                    layer.alert("附件上传成功");
                    $('#bootstrap-table').bootstrapTable('refresh');
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    layer.alert("附件上传失败");
                }
            });

            // $('#' + previewId).attr('fileid', data.response.data);
        }).on('filesuccessremove', function (event, previewId, extra) {
            //在移除事件里取出所需数据，并执行相应的删除指令
            var id = $('#' + previewId).attr('fileid');
            removefile(id);
        });
        $(".file-preview").hide();


        var control2 = $('#fileinput-demo-2');
        control2.fileinput({
            language: 'zh', //设置语言
            uploadUrl: '/common/upload2', //上传的地址
            deleteUrl: prefix + '/removeFile',//删除图片地址
            allowedFileExtensions: ['jpg', 'png', 'gif', 'doc', 'xlsx', 'xls','pdf','docx'],//接收的文件后缀
            showUpload: true, //是否显示上传按钮
            maxFileCount: 1,//最大可选文件数
            showCaption: true,//是否显示标题
            browseClass: "btn btn-primary", //按钮样式
            previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
            preferIconicPreview: true,
            overwriteInitial: false,//覆盖初始化
            showRemove: false, //是否显示清除按钮
            initialPreview: [ ""],//编辑时显示 <img src='/img/profile.jpg' class='file-preview-image'>", "<img src='/img/top.png' class='file-preview-image'>
            //initialPreviewConfig: [ { url:prefix + '/delfile',id: '0'}, { url:prefix + '/delfile',id: '0' } ]//编辑时显示图片相关属性， key:文件id, url: 删除方法
        });
        //files为fileinput控件ID，
        $('#fileinput-demo-2').on('fileuploaded', function (e, data, previewId, index) {
            //在上传成功事件中将服务器返回的所需数据，添加到该文件对应的div中
            var url = data.response.url;
            console.log(url);
            $("#liveView").val(url);

            // $('#' + previewId).attr('fileid', data.response.data);
        }).on('filesuccessremove', function (event, previewId, extra) {
            //在移除事件里取出所需数据，并执行相应的删除指令
            var id = $('#' + previewId).attr('fileid');
            removefile(id);
        });


    });

    function removefile(id) {
        layer.confirm("是否删除", {
            btn: ['是', '否']
        }, function () {
            $.ajax({
                url: prefix + '/delfile',
                data: {id: id},
                dataType: 'json',
                type: "post",
                success: function (result) {
                    layer.close(layer.index);
                    $('#bootstrap-table').bootstrapTable('refresh');
                }
            })
        }, function () {

        })
    }
</script>
</body>
</html>
